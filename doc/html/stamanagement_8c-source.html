<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=euc-jp">
<title>STA Management Daemon: stamanagement.c ソースファイル</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- 作成： Doxygen 1.5.1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>メインページ</span></a></li>
    <li><a href="annotated.html"><span>データ構造</span></a></li>
    <li id="current"><a href="files.html"><span>ファイル</span></a></li>
    <li><a href="pages.html"><span>関連ページ</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>ファイル一覧</span></a></li>
    <li><a href="globals.html"><span>グローバル</span></a></li>
  </ul></div>
<h1>stamanagement.c</h1><a href="stamanagement_8c.html">説明を見る。</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;ifaddrs.h&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#if 0</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;linux/ipv6.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#endif</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;linux/sockios.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;net/if.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;stropts.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;syslog.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;sys/fcntl.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="stamanagement_8h.html">stamanagement.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="sta__timer_8h.html">sta_timer.h</a>"</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#ifndef _LINUX_IN6_H</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00067"></a><a class="code" href="structin6__ifreq.html">00067</a> <span class="keyword">struct </span><a class="code" href="structin6__ifreq.html">in6_ifreq</a> {
<a name="l00068"></a><a class="code" href="structin6__ifreq.html#c42518a11ef89651f83a1407969fb303">00068</a>     <span class="keyword">struct </span>in6_addr ifr6_addr;
<a name="l00069"></a><a class="code" href="structin6__ifreq.html#aa90545d34462d8eac46393ea8a5469c">00069</a>     uint32_t <a class="code" href="structin6__ifreq.html#aa90545d34462d8eac46393ea8a5469c">ifr6_prefixlen</a>;
<a name="l00070"></a><a class="code" href="structin6__ifreq.html#d419deb2f8fee6d9d0ae797261b1e6c2">00070</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structin6__ifreq.html#d419deb2f8fee6d9d0ae797261b1e6c2">ifr6_ifindex</a>;
<a name="l00071"></a>00071 };
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00083"></a><a class="code" href="stamanagement_8c.html#1cc481b5987378c013d3437c5ffafa37">00083</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#1cc481b5987378c013d3437c5ffafa37">in6_addr_equal</a>(<span class="keyword">const</span> <span class="keyword">struct</span> in6_addr *a, <span class="keyword">const</span> <span class="keyword">struct</span> in6_addr *b) {
<a name="l00084"></a>00084     <span class="keywordflow">return</span> (memcmp(a, b, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> in6_addr)) == 0);
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00094"></a><a class="code" href="stamanagement_8h.html#00324e0b02ef9c19bcc630c1e8b687ee">00094</a> <span class="keywordtype">void</span> *<a class="code" href="stamanagement_8c.html#00324e0b02ef9c19bcc630c1e8b687ee">recv_from_fifo</a>(<span class="keywordtype">void</span> *arg) {
<a name="l00095"></a>00095     <a class="code" href="stamanagement_8h.html#86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(arg);
<a name="l00096"></a>00096     
<a name="l00097"></a>00097     <span class="keywordtype">int</span> fd; 
<a name="l00098"></a>00098     <span class="keywordtype">int</span> len;
<a name="l00099"></a>00099     <a class="code" href="struct__PositionOut.html">PositionOut</a> output;
<a name="l00100"></a>00100     <span class="keyword">struct </span>ifaddrs *ifap0, *ifap;
<a name="l00101"></a>00101     <span class="keywordtype">char</span> host[NI_MAXHOST];
<a name="l00102"></a>00102     <span class="keywordtype">int</span> found = 0;
<a name="l00103"></a>00103     <span class="keyword">struct </span>sockaddr_in6 sin6;
<a name="l00104"></a>00104     <span class="keyword">struct </span>sockaddr_in6 oldsta_sin6;
<a name="l00105"></a>00105     <span class="keyword">struct </span>in6_addr *oldsta = NULL; 
<a name="l00106"></a>00106     <a class="code" href="struct__PositionOut.html">PositionOut</a> decode;
<a name="l00107"></a>00107     <span class="keywordtype">int</span> duplicate;
<a name="l00108"></a>00108     <span class="keyword">struct </span>timeval tv;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     memset(&amp;output, 0, <span class="keyword">sizeof</span>(output));
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="keywordflow">if</span> ((fd = open(<a class="code" href="stamanagement_8h.html#64d743b19034f4f56fe32383fd890b00">fifo_path</a>, O_RDONLY)) == -1) {
<a name="l00113"></a>00113         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_fifo] %m : open %s"</span>, <a class="code" href="stamanagement_8h.html#64d743b19034f4f56fe32383fd890b00">fifo_path</a>);
<a name="l00114"></a>00114         <span class="keywordflow">return</span> NULL;
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keywordflow">while</span> (!<a class="code" href="stamanagement_8h.html#3a342de928b87eb91a4dc575124c38ad">srv_shutdown</a>) {
<a name="l00118"></a>00118         len = read(fd, &amp;output, <span class="keyword">sizeof</span>(output));
<a name="l00119"></a>00119         
<a name="l00120"></a>00120         <span class="comment">// 以下の処理が重くなるようなら別スレッドにするべきかも</span>
<a name="l00121"></a>00121         <span class="keywordflow">if</span> (len == 0) {
<a name="l00122"></a>00122             fprintf(stderr, <span class="stringliteral">"[recv_from_fifo] read size 0\n"</span>);
<a name="l00123"></a>00123             <span class="keywordflow">break</span>;
<a name="l00124"></a>00124         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00125"></a>00125             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_fifo] read error: %m"</span>);
<a name="l00126"></a>00126             fprintf(stderr, <span class="stringliteral">"[recv_from_fifo] read error: %m"</span>);
<a name="l00127"></a>00127             <span class="keywordflow">continue</span>;
<a name="l00128"></a>00128         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l00129"></a>00129             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_fifo] index=%lu"</span>, output.index);
<a name="l00130"></a>00130 
<a name="l00131"></a>00131             <span class="comment">// ath0にSTAが割り当てられているかチェック</span>
<a name="l00132"></a>00132             <span class="comment">// アドレスがセットされていなければセット</span>
<a name="l00133"></a>00133             <span class="keywordflow">if</span> (getifaddrs(&amp;ifap0)) {
<a name="l00134"></a>00134                  syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_fifo] getifaddrs error %m"</span>);
<a name="l00135"></a>00135             }
<a name="l00136"></a>00136             <span class="keywordflow">for</span> (ifap = ifap0; ifap; ifap = ifap-&gt;ifa_next) {
<a name="l00137"></a>00137                 <span class="keywordflow">if</span> (strstr(ifap-&gt;ifa_name, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>)) {
<a name="l00138"></a>00138                     if (ifap-&gt;ifa_addr == NULL) {
<a name="l00139"></a>00139                         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_fifo] %s ifa_addr is NULL!!"</span>, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>);
<a name="l00140"></a>00140                         <span class="keywordflow">continue</span>;
<a name="l00141"></a>00141                     }
<a name="l00142"></a>00142                     <span class="keywordflow">if</span> (ifap-&gt;ifa_addr-&gt;sa_family == AF_INET6) {
<a name="l00143"></a>00143                         getnameinfo(ifap-&gt;ifa_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in6), host, <span class="keyword">sizeof</span>(host), NULL, 0, NI_NUMERICHOST);
<a name="l00144"></a>00144                         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_fifo] address = %s"</span>, host);
<a name="l00145"></a>00145                         
<a name="l00146"></a>00146                         <span class="keyword">struct </span>sockaddr_in6 *temp_sockaddr_in6 = (<span class="keyword">struct </span>sockaddr_in6 *)(ifap-&gt;ifa_addr);
<a name="l00147"></a>00147                         if (<a class="code" href="stamanagement_8h.html#1fc4ca40df850703f916d515f1d8ba8b">IN6_IS_ADDR_STA</a>(&amp;temp_sockaddr_in6-&gt;sin6_addr)) {
<a name="l00148"></a>00148                             found = 1;
<a name="l00149"></a>00149                             oldsta_sin6 = *temp_sockaddr_in6;
<a name="l00150"></a>00150                             oldsta = &amp;oldsta_sin6.sin6_addr;
<a name="l00151"></a>00151                             <span class="keywordflow">break</span>;
<a name="l00152"></a>00152                         } <span class="keywordflow">else</span> {
<a name="l00153"></a>00153                             <span class="keywordflow">continue</span>;
<a name="l00154"></a>00154                         }
<a name="l00155"></a>00155                     } <span class="keywordflow">else</span> {
<a name="l00156"></a>00156                         <span class="comment">// v4アドレス</span>
<a name="l00157"></a>00157                         <span class="keywordflow">continue</span>;
<a name="l00158"></a>00158                     }
<a name="l00159"></a>00159                 } <span class="keywordflow">else</span> {
<a name="l00160"></a>00160                     <span class="comment">// ath0以外</span>
<a name="l00161"></a>00161                     <span class="keywordflow">continue</span>;
<a name="l00162"></a>00162                 }
<a name="l00163"></a>00163             }
<a name="l00164"></a>00164             
<a name="l00165"></a>00165             <span class="keywordflow">if</span> (!found) { <span class="comment">// 見つからなかった</span>
<a name="l00166"></a>00166                 <a class="code" href="stamanagement_8c.html#4f0d36fa91dbfcb9acebfb2df7d1b5b3">encode_to_sta</a>(output, &amp;(sin6.sin6_addr));
<a name="l00167"></a>00167                 sin6.sin6_family = AF_INET6;
<a name="l00168"></a>00168                 
<a name="l00169"></a>00169                 pthread_mutex_lock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00170"></a>00170                 if (<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> == <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f42148610025b91763a4a8f6d4702fcc57c8">DAD</a>) {
<a name="l00171"></a>00171                     pthread_mutex_unlock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00172"></a>00172                     <span class="keywordflow">continue</span>;
<a name="l00173"></a>00173                 }
<a name="l00174"></a>00174                 
<a name="l00175"></a>00175                 gettimeofday(&amp;tv, NULL);
<a name="l00176"></a>00176                 <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#49a9f14a6ce5e86faff0d96db622a850">generated_time</a> = tv.tv_sec;
<a name="l00177"></a>00177                 <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a> = sin6;
<a name="l00178"></a>00178                 <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> = <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f42148610025b91763a4a8f6d4702fcc57c8">DAD</a>;
<a name="l00179"></a>00179                 pthread_mutex_unlock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00180"></a>00180                 
<a name="l00181"></a>00181                 duplicate = <a class="code" href="stamanagement_8c.html#d870eaad22c93853e0bb544274d6699b">allocation_request_start</a>(sin6); <span class="comment">// AREQを送ってWT待つ</span>
<a name="l00182"></a>00182             } <span class="keywordflow">else</span> { <span class="comment">// 見つかった</span>
<a name="l00183"></a>00183                 <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8c.html#9b23299962baf5c9ed9111c279eeacfe">decode_from_sta</a>(oldsta, &amp;decode) == -1) {
<a name="l00184"></a>00184                     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_fifo] decode_from_sta error"</span>);
<a name="l00185"></a>00185                     <span class="keywordflow">continue</span>;
<a name="l00186"></a>00186                 }
<a name="l00187"></a>00187                 
<a name="l00188"></a>00188                 <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8c.html#b0d5fc7ffa90be68cc7cc71dd629d90e">is_inside_valid_range</a>(&amp;output, &amp;decode)) { <span class="comment">// 有効範囲以内なら抜ける</span>
<a name="l00189"></a>00189                     <span class="comment">// syslog(LOG_LOCAL0|LOG_DEBUG, "[recv_from_fifo] OK, in the STA valid range.");</span>
<a name="l00190"></a>00190                     <span class="comment">// do nothing.</span>
<a name="l00191"></a>00191                 } <span class="keywordflow">else</span> { <span class="comment">// 範囲を出ていれば、アドレスを更新</span>
<a name="l00192"></a>00192                     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[recv_from_fifo] No! outside the range.");</span>
<a name="l00193"></a>00193                     <a class="code" href="stamanagement_8c.html#4f0d36fa91dbfcb9acebfb2df7d1b5b3">encode_to_sta</a>(output, &amp;(sin6.sin6_addr));
<a name="l00194"></a>00194                     sin6.sin6_family = AF_INET6;
<a name="l00195"></a>00195                     
<a name="l00196"></a>00196                     pthread_mutex_lock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00197"></a>00197                     <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> == <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f42148610025b91763a4a8f6d4702fcc57c8">DAD</a>) {
<a name="l00198"></a>00198                         pthread_mutex_unlock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00199"></a>00199                         <span class="keywordflow">continue</span>;
<a name="l00200"></a>00200                     }
<a name="l00201"></a>00201                     
<a name="l00202"></a>00202                     gettimeofday(&amp;tv, NULL);
<a name="l00203"></a>00203                     <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#49a9f14a6ce5e86faff0d96db622a850">generated_time</a> = tv.tv_sec;
<a name="l00204"></a>00204                     <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a> = sin6;
<a name="l00205"></a>00205                     <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> = <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f42148610025b91763a4a8f6d4702fcc57c8">DAD</a>;
<a name="l00206"></a>00206                     pthread_mutex_unlock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00207"></a>00207                     
<a name="l00208"></a>00208                     duplicate = <a class="code" href="stamanagement_8c.html#d870eaad22c93853e0bb544274d6699b">allocation_request_start</a>(sin6); <span class="comment">// AREQを送ってWT待つ</span>
<a name="l00209"></a>00209                 }
<a name="l00210"></a>00210             }
<a name="l00211"></a>00211             fprintf(stderr, <span class="stringliteral">"srv_shutdown %d\n"</span>, <a class="code" href="stamanagement_8h.html#3a342de928b87eb91a4dc575124c38ad">srv_shutdown</a>);
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213         fprintf(stderr, <span class="stringliteral">"srv_shutdown %d\n"</span>, <a class="code" href="stamanagement_8h.html#3a342de928b87eb91a4dc575124c38ad">srv_shutdown</a>);
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     fprintf(stderr, <span class="stringliteral">"srv_shutdown %d\n"</span>, <a class="code" href="stamanagement_8h.html#3a342de928b87eb91a4dc575124c38ad">srv_shutdown</a>);
<a name="l00216"></a>00216     <span class="keywordflow">return</span> NULL;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00233"></a><a class="code" href="stamanagement_8c.html#4f0d36fa91dbfcb9acebfb2df7d1b5b3">00233</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#4f0d36fa91dbfcb9acebfb2df7d1b5b3">encode_to_sta</a>(<a class="code" href="struct__PositionOut.html">PositionOut</a> po, <span class="keyword">struct</span> in6_addr *newsta) {
<a name="l00234"></a>00234     <span class="keywordtype">int</span> templatitude;
<a name="l00235"></a>00235     <span class="keywordtype">int</span> templongitude;
<a name="l00236"></a>00236     <span class="keywordtype">int</span> tempaltitude;
<a name="l00237"></a>00237     <span class="keywordtype">int</span> temptime;
<a name="l00238"></a>00238     <span class="keyword">struct </span>tm *tm_temptime;
<a name="l00239"></a>00239     <span class="keywordtype">char</span> *temp;
<a name="l00240"></a>00240     
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (po.<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> &gt; 90.0 || po.<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> &lt; -90.0) {
<a name="l00242"></a>00242         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[encode_to_sta] latitude range error"</span>);
<a name="l00243"></a>00243         <span class="keywordflow">return</span> -1;
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (po.<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> &gt; 180.0 || po.<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> &lt; -180.0) {
<a name="l00246"></a>00246         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[encode_to_sta] longitude range error"</span>);
<a name="l00247"></a>00247         <span class="keywordflow">return</span> -1;
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249     
<a name="l00250"></a>00250     <span class="comment">// 緯線1m分=4.49*10^(-6)度より、小数点以下6桁までとる</span>
<a name="l00251"></a>00251     templatitude = (int)floor((po.<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> + 90.0) * 10.0 * 10.0 * 10.0 * 10.0 * 10.0 * 10.0);
<a name="l00252"></a>00252     <span class="comment">// 緯度 最大180度、小数以下6桁 180000000 --&gt; 28bit このうち上位から26bitを取り出す</span>
<a name="l00253"></a>00253     templatitude &amp;= 0xffffffc;
<a name="l00254"></a>00254     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[encode_to_sta] templatitude 28bit = %d", templatitude);</span>
<a name="l00255"></a>00255     templatitude = (templatitude &gt;&gt; 2);
<a name="l00256"></a>00256     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[encode_to_sta] templatitude 26bit = %d", templatitude);</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 
<a name="l00259"></a>00259     <span class="comment">// 赤道上で経線1m分=8.99*10^(-6)度なので小数点以下5桁でおおよそ十分だが</span>
<a name="l00260"></a>00260     <span class="comment">// 確実に精度を保証するためと、緯度とそろえるため6桁までとることとした。</span>
<a name="l00261"></a>00261     templongitude = (int)floor((po.<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> + 180.0) * 10.0 * 10.0 * 10.0 * 10.0 * 10.0 * 10.0);
<a name="l00262"></a>00262     <span class="comment">// 経度 最大360度、小数点以下6桁 360000000 --&gt; 29bit このうち『上位から』26bitを取り出す</span>
<a name="l00263"></a>00263     templongitude &amp;= 0x1ffffff8;
<a name="l00264"></a>00264     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[encode_to_sta] templongitude 29bit = %d", templongitude);</span>
<a name="l00265"></a>00265     templongitude = (templongitude &gt;&gt; 3);
<a name="l00266"></a>00266     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[encode_to_sta] templongitude 26bit = %d", templongitude);</span>
<a name="l00267"></a>00267     
<a name="l00268"></a>00268     tempaltitude = (int)floor(po.<a class="code" href="struct__PositionOut.html#29420cc0d296ac59627b0b9a478a1589">alt</a> / 2.0); <span class="comment">// 2m粒度、いまは下駄を足していないし14bitのマスクもかけていない</span>
<a name="l00269"></a>00269     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[encode_to_sta] tempaltitude 14bit = %d", tempaltitude);</span>
<a name="l00270"></a>00270     
<a name="l00271"></a>00271     <span class="comment">// timeは10秒粒度とすればもともと14bitなのでマスクする必要なし</span>
<a name="l00272"></a>00272     tm_temptime = (<span class="keyword">struct </span>tm *)malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm));
<a name="l00273"></a>00273     memset(tm_temptime, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tm));
<a name="l00274"></a>00274     localtime_r(&amp;(po.<a class="code" href="struct__PositionOut.html#747e7c87db72e2087b6aa2fdc3721b75">time</a>), tm_temptime);
<a name="l00275"></a>00275     temptime = (tm_temptime-&gt;tm_hour * 60 * 60 + tm_temptime-&gt;tm_min * 60 + tm_temptime-&gt;tm_sec) / 10;
<a name="l00276"></a>00276     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[encode_to_sta] temptime 14bit = %d", temptime);</span>
<a name="l00277"></a>00277     
<a name="l00278"></a>00278     newsta-&gt;s6_addr16[7] = htons(((tempaltitude &amp; 0x3) &lt;&lt; 14) + temptime); <span class="comment">// alt2bit + time14bit</span>
<a name="l00279"></a>00279     newsta-&gt;s6_addr16[6] = htons(((templatitude &amp; 0xf) &lt;&lt; 12) + ((tempaltitude &amp; 0x3ffc) &gt;&gt; 2)); <span class="comment">// lat4bit + alt12bit</span>
<a name="l00280"></a>00280     newsta-&gt;s6_addr16[5] = htons((templatitude &amp; 0xffff0) &gt;&gt; 4); <span class="comment">// lat16bit</span>
<a name="l00281"></a>00281     newsta-&gt;s6_addr16[4] = htons(((templongitude &amp; 0x3ff) &lt;&lt; 6) + ((templatitude &amp; 0x3f00000) &gt;&gt; 20)); <span class="comment">// lon10bit + lat6bit</span>
<a name="l00282"></a>00282     newsta-&gt;s6_addr16[3] = htons((templongitude &amp; 0x3fffc00) &gt;&gt; 10); <span class="comment">// lon16bit</span>
<a name="l00283"></a>00283     newsta-&gt;s6_addr16[2] = 0;
<a name="l00284"></a>00284     newsta-&gt;s6_addr16[1] = htons(0x200);
<a name="l00285"></a>00285     newsta-&gt;s6_addr16[0] = htons(0x2001);
<a name="l00286"></a>00286     
<a name="l00287"></a>00287     free(tm_temptime);
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     temp = (<span class="keywordtype">char</span> *)malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * 512);
<a name="l00290"></a>00290     <span class="keywordflow">if</span> (inet_ntop(AF_INET6, newsta, temp, 512) == NULL) {
<a name="l00291"></a>00291         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[encode_to_sta] inet_ntop: %m"</span>);
<a name="l00292"></a>00292         free(temp);
<a name="l00293"></a>00293         <span class="keywordflow">return</span> -1;
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295     
<a name="l00296"></a>00296     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[encode_to_sta] New STA: %s"</span>, temp);
<a name="l00297"></a>00297     free(temp);
<a name="l00298"></a>00298     <span class="keywordflow">return</span> 0;
<a name="l00299"></a>00299 }
<a name="l00300"></a>00300 
<a name="l00310"></a><a class="code" href="stamanagement_8c.html#9b23299962baf5c9ed9111c279eeacfe">00310</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#9b23299962baf5c9ed9111c279eeacfe">decode_from_sta</a>(<span class="keyword">struct</span> in6_addr *sta, <a class="code" href="struct__PositionOut.html">PositionOut</a> *po) {
<a name="l00311"></a>00311     <span class="keywordtype">int</span> temp;
<a name="l00312"></a>00312     
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (po == NULL) {
<a name="l00314"></a>00314         <span class="keywordflow">return</span> -1;
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316     
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (!<a class="code" href="stamanagement_8h.html#1fc4ca40df850703f916d515f1d8ba8b">IN6_IS_ADDR_STA</a>(sta)) {
<a name="l00318"></a>00318         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[decode_from_sta] this is not an sta."</span>);
<a name="l00319"></a>00319         <span class="keywordflow">return</span> -1;
<a name="l00320"></a>00320     }
<a name="l00321"></a>00321     
<a name="l00322"></a>00322     <span class="comment">// 以下はSTA中に情報がないので復元不可能。</span>
<a name="l00323"></a>00323     po-&gt;<a class="code" href="struct__PositionOut.html#4a60e5344db868390ac05e5c0c52eb9f">index</a> = 0;
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[decode_from_sta] sta-&gt;s6_addr16[0,1,2,3,4,5,6,7] = (%d, %d, %d, %d, %d, %d, %d, %d)", sta-&gt;s6_addr16[0], sta-&gt;s6_addr16[1], sta-&gt;s6_addr16[2], sta-&gt;s6_addr16[3], sta-&gt;s6_addr16[4], sta-&gt;s6_addr16[5], sta-&gt;s6_addr16[6], sta-&gt;s6_addr16[7]);</span>
<a name="l00326"></a>00326     
<a name="l00327"></a>00327     po-&gt;<a class="code" href="struct__PositionOut.html#747e7c87db72e2087b6aa2fdc3721b75">time</a> = (time_t)(((<span class="keywordtype">int</span>)ntohs(sta-&gt;s6_addr16[7]) &amp; 0x3fff) * 10); <span class="comment">// [7]下位14bit</span>
<a name="l00328"></a>00328     
<a name="l00329"></a>00329     temp = (((int)ntohs(sta-&gt;s6_addr16[6]) &amp; 0xfff) &lt;&lt; 2) + (((int)ntohs(sta-&gt;s6_addr16[7]) &amp; 0xc000) &gt;&gt; 14); <span class="comment">// [6]下位12bit + [7]上位2bit</span>
<a name="l00330"></a>00330     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[decode_from_sta] tempaltitude = %d", temp);</span>
<a name="l00331"></a>00331     po-&gt;<a class="code" href="struct__PositionOut.html#29420cc0d296ac59627b0b9a478a1589">alt</a> = temp * 2.0; 
<a name="l00332"></a>00332     
<a name="l00333"></a>00333     temp = (((int)ntohs(sta-&gt;s6_addr16[4]) &amp; 0x3f) &lt;&lt; 20) + ((int)ntohs(sta-&gt;s6_addr16[5]) &lt;&lt; 4) + (((<span class="keywordtype">int</span>)ntohs(sta-&gt;s6_addr16[6]) &amp; 0xf000) &gt;&gt; 12); <span class="comment">// [4]下位6bit + [5]16bit全部 + [6]上位4bit</span>
<a name="l00334"></a>00334     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[decode_from_sta] templatitude = %d", temp);  </span>
<a name="l00335"></a>00335     po-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> = (temp &lt;&lt; 2) / 1000000.0 - 90.0;
<a name="l00336"></a>00336     
<a name="l00337"></a>00337     temp = ((int)ntohs(sta-&gt;s6_addr16[3]) &lt;&lt; 10) + (((<span class="keywordtype">int</span>)ntohs(sta-&gt;s6_addr16[4]) &amp; 0xffc0) &gt;&gt; 6); <span class="comment">// [3]16bit全部 + [4]上位10bit</span>
<a name="l00338"></a>00338     <span class="comment">//syslog(LOG_LOCAL0|LOG_DEBUG, "[decode_from_sta] templongitude = %d", temp);</span>
<a name="l00339"></a>00339     po-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> = (temp &lt;&lt; 3) / 1000000.0 - 180.0;
<a name="l00340"></a>00340     
<a name="l00341"></a>00341     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[decode_from_sta] (time,lng,lat,alt)=(%ld, %f, %f, %f)"</span>, po-&gt;<a class="code" href="struct__PositionOut.html#747e7c87db72e2087b6aa2fdc3721b75">time</a>, po-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, po-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>, po-&gt;<a class="code" href="struct__PositionOut.html#29420cc0d296ac59627b0b9a478a1589">alt</a>);
<a name="l00342"></a>00342     
<a name="l00343"></a>00343     <span class="keywordflow">return</span> 0;
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00355"></a><a class="code" href="stamanagement_8c.html#4594982b4b7c93034dde116a25ef701b">00355</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#4594982b4b7c93034dde116a25ef701b">add_sta</a>(<span class="keyword">struct</span> sockaddr_in6 *newsta) {
<a name="l00356"></a>00356     <span class="keywordtype">int</span> fd = -1;
<a name="l00357"></a>00357     <span class="keyword">struct </span>ifreq ifr;
<a name="l00358"></a>00358     <span class="keyword">struct </span><a class="code" href="structin6__ifreq.html">in6_ifreq</a> ifr6;
<a name="l00359"></a>00359     <span class="keywordtype">char</span> host[NI_MAXHOST];
<a name="l00360"></a>00360     
<a name="l00361"></a>00361     newsta-&gt;sin6_family = AF_INET6;
<a name="l00362"></a>00362     newsta-&gt;sin6_port = 0;
<a name="l00363"></a>00363     memcpy((<span class="keywordtype">char</span> *)&amp;ifr6.<a class="code" href="structin6__ifreq.html#c42518a11ef89651f83a1407969fb303">ifr6_addr</a>, (<span class="keywordtype">char</span> *)&amp;(newsta-&gt;sin6_addr), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> in6_addr));
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     fd = <a class="code" href="stamanagement_8c.html#ef019ef18a588d7ec1c27c3ca3a11892">get_socket_for_afinet6</a>();
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00367"></a>00367         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[update_sta] No support for INET6 on this system."</span>);
<a name="l00368"></a>00368         <span class="keywordflow">return</span> -1;
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     strcpy(ifr.ifr_name, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>);
<a name="l00372"></a>00372     <span class="comment">// SIOGIFINDEXとSIOCGIFINDEXは同じ。typo予防のdefine。</span>
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (ioctl(fd, SIOCGIFINDEX, &amp;ifr) &lt; 0) {
<a name="l00374"></a>00374         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[update_sta] SIOCGIFINDEX error: %m"</span>);
<a name="l00375"></a>00375         <span class="keywordflow">return</span> -1;
<a name="l00376"></a>00376     }
<a name="l00377"></a>00377     ifr6.<a class="code" href="structin6__ifreq.html#d419deb2f8fee6d9d0ae797261b1e6c2">ifr6_ifindex</a> = ifr.ifr_ifindex;
<a name="l00378"></a>00378     ifr6.<a class="code" href="structin6__ifreq.html#aa90545d34462d8eac46393ea8a5469c">ifr6_prefixlen</a> = 0;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="comment">// 以下のアドレス設定のioctlはrootでないと実行不可能.</span>
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (ioctl(fd, SIOCSIFADDR, &amp;ifr6) &lt; 0) {
<a name="l00382"></a>00382         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[update_sta] SIOCSIFADDR error: %m"</span>);
<a name="l00383"></a>00383         <span class="keywordflow">return</span> -1;
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385     
<a name="l00386"></a>00386     <span class="comment">// ログに記録</span>
<a name="l00387"></a>00387     getnameinfo((<span class="keyword">struct</span> sockaddr *)newsta, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in6), host, <span class="keyword">sizeof</span>(host), NULL, 0, NI_NUMERICHOST);
<a name="l00388"></a>00388     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"# add_sta complete, new address = %s"</span>, host);
<a name="l00389"></a>00389     
<a name="l00390"></a>00390     <span class="keywordflow">return</span> 0;
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00401"></a><a class="code" href="stamanagement_8c.html#de7e1ba2d15a89b76013f06794fc111b">00401</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#de7e1ba2d15a89b76013f06794fc111b">delete_sta</a>(<span class="keyword">struct</span> sockaddr_in6 *oldsta) {
<a name="l00402"></a>00402     <span class="keywordtype">int</span> fd = -1;
<a name="l00403"></a>00403     <span class="keyword">struct </span>ifreq ifr;
<a name="l00404"></a>00404     <span class="keyword">struct </span><a class="code" href="structin6__ifreq.html">in6_ifreq</a> ifr6;
<a name="l00405"></a>00405     
<a name="l00406"></a>00406     memcpy((<span class="keywordtype">char</span> *)&amp;ifr6.<a class="code" href="structin6__ifreq.html#c42518a11ef89651f83a1407969fb303">ifr6_addr</a>, (<span class="keywordtype">char</span> *)&amp;(oldsta-&gt;sin6_addr), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> in6_addr));
<a name="l00407"></a>00407     
<a name="l00408"></a>00408     fd = <a class="code" href="stamanagement_8c.html#ef019ef18a588d7ec1c27c3ca3a11892">get_socket_for_afinet6</a>();
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00410"></a>00410         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[delete_sta] No support for INET6 on this system."</span>);
<a name="l00411"></a>00411         <span class="keywordflow">return</span> -1;
<a name="l00412"></a>00412     }
<a name="l00413"></a>00413     
<a name="l00414"></a>00414     strcpy(ifr.ifr_name, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>);
<a name="l00415"></a>00415     <span class="comment">// SIOGIFINDEXとSIOCGIFINDEXは同じ。typo予防のdefine。</span>
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (ioctl(fd, SIOCGIFINDEX, &amp;ifr) &lt; 0) {
<a name="l00417"></a>00417         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[delete_sta] SIOGIFINDEX error: %m"</span>);
<a name="l00418"></a>00418         <span class="keywordflow">return</span> -1;
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420     ifr6.<a class="code" href="structin6__ifreq.html#d419deb2f8fee6d9d0ae797261b1e6c2">ifr6_ifindex</a> = ifr.ifr_ifindex;
<a name="l00421"></a>00421     ifr6.<a class="code" href="structin6__ifreq.html#aa90545d34462d8eac46393ea8a5469c">ifr6_prefixlen</a> = 0;
<a name="l00422"></a>00422     
<a name="l00423"></a>00423     <span class="comment">// 以下のアドレス設定のioctlはrootでないと実行不可能.</span>
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (ioctl(fd, SIOCDIFADDR, &amp;ifr6) &lt; 0) {
<a name="l00425"></a>00425         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[delete_sta] SIOCDIFADDR error: %m"</span>);
<a name="l00426"></a>00426         <span class="keywordflow">return</span> -1;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     
<a name="l00429"></a>00429     <span class="keywordflow">return</span> 0;
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00440"></a><a class="code" href="stamanagement_8c.html#d870eaad22c93853e0bb544274d6699b">00440</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#d870eaad22c93853e0bb544274d6699b">allocation_request_start</a>(<span class="keyword">struct</span> sockaddr_in6 newsta) {
<a name="l00441"></a>00441     <span class="keywordtype">int</span> ret;
<a name="l00442"></a>00442     <span class="keyword">struct </span>sockaddr_in6 toaddr_in6;
<a name="l00443"></a>00443     u_int16_t type;
<a name="l00444"></a>00444     u_int16_t reserved = 0;
<a name="l00445"></a>00445     <span class="keywordtype">char</span> *buf;
<a name="l00446"></a>00446     <span class="keywordtype">char</span> host[NI_MAXHOST];
<a name="l00447"></a>00447     
<a name="l00448"></a>00448     memset(&amp;toaddr_in6, <span class="keyword">sizeof</span>(toaddr_in6), 0);
<a name="l00449"></a>00449     toaddr_in6.sin6_family = AF_INET6;
<a name="l00450"></a>00450     toaddr_in6.sin6_addr = <a class="code" href="stamanagement_8h.html#91bb6dfcba13de586d77afd7ae5631e3">in6addr_linklocalmulticast</a>;
<a name="l00451"></a>00451     toaddr_in6.sin6_port = htons(<a class="code" href="stamanagement_8h.html#8080d4d36d5d3d072be611a95f864ac1">udp_port</a>);
<a name="l00452"></a>00452     
<a name="l00453"></a>00453     type = <a class="code" href="stamanagement_8h.html#bc6e8f82175898b9c0bc5049571b474b9ab10d084d2aa43c5a5fee1ae99a8968">AREQ</a>;
<a name="l00454"></a>00454     
<a name="l00455"></a>00455     buf = (<span class="keywordtype">char</span> *)malloc(<a class="code" href="stamanagement_8h.html#e1b5756eb552a240b40b0d39b865e96a">AREQ_PACKET_SIZE</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l00456"></a>00456     memset(buf, 0, <a class="code" href="stamanagement_8h.html#e1b5756eb552a240b40b0d39b865e96a">AREQ_PACKET_SIZE</a>);
<a name="l00457"></a>00457     memcpy(buf, &amp;type, <span class="keyword">sizeof</span>(type));
<a name="l00458"></a>00458     <span class="comment">// memcpy(buf[sizeof(type)], reserved, sizeof(reserved)); // 今のところ0なので実質不要</span>
<a name="l00459"></a>00459     memcpy(&amp;(buf[<span class="keyword">sizeof</span>(type) + <span class="keyword">sizeof</span>(reserved)]), &amp;newsta, <span class="keyword">sizeof</span>(newsta));
<a name="l00460"></a>00460     
<a name="l00461"></a>00461     <span class="comment">// ログに記録</span>
<a name="l00462"></a>00462     <span class="keywordflow">if</span> ((ret = getnameinfo((<span class="keyword">struct</span> sockaddr *)&amp;newsta, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in6), host, <span class="keyword">sizeof</span>(host), NULL, 0, NI_NUMERICHOST)) != 0) {
<a name="l00463"></a>00463         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[allocation_request_start] getnameinfo error: %s"</span>, gai_strerror(ret));
<a name="l00464"></a>00464     } <span class="keywordflow">else</span> {
<a name="l00465"></a>00465         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"# allocation_request_start temp address = %s"</span>, host);
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467     
<a name="l00468"></a>00468     <span class="comment">// ブロードキャストでsend</span>
<a name="l00469"></a>00469     ret = sendto(<a class="code" href="stamanagement_8h.html#d2c8fb3df3a737e0685e902870a611d2">sockfd</a>, buf, <a class="code" href="stamanagement_8h.html#e1b5756eb552a240b40b0d39b865e96a">AREQ_PACKET_SIZE</a>, 0, (<span class="keyword">struct</span> sockaddr *)&amp;toaddr_in6, <span class="keyword">sizeof</span>(toaddr_in6));
<a name="l00470"></a>00470     
<a name="l00471"></a>00471     <span class="comment">// WT秒のタイマーオン</span>
<a name="l00472"></a>00472     <a class="code" href="sta__timer_8c.html#132d31dc746d9938e3b714139e65b83b">timer_on</a>(0, &amp;<a class="code" href="stamanagement_8c.html#1390641a02e1bfd0559b339469b76211">allocation_request_timeout</a>, <a class="code" href="stamanagement_8h.html#852214fee107d32377ac550a65b57637">waiting_time</a>);
<a name="l00473"></a>00473     
<a name="l00474"></a>00474     free(buf);
<a name="l00475"></a>00475     <span class="keywordflow">return</span> 0;
<a name="l00476"></a>00476 }
<a name="l00477"></a>00477 
<a name="l00485"></a><a class="code" href="stamanagement_8c.html#1390641a02e1bfd0559b339469b76211">00485</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stamanagement_8c.html#1390641a02e1bfd0559b339469b76211">allocation_request_timeout</a>() {
<a name="l00486"></a>00486     <span class="keyword">struct </span>ifaddrs *ifap0, *ifap;
<a name="l00487"></a>00487     <span class="keyword">struct </span>sockaddr_in6 mysta_sin6;
<a name="l00488"></a>00488     <span class="keywordtype">int</span> found = 0;
<a name="l00489"></a>00489     
<a name="l00490"></a>00490     pthread_mutex_lock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00491"></a>00491     <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> == <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f42148610025b91763a4a8f6d4702fcc57c8">DAD</a>) {
<a name="l00492"></a>00492         <span class="comment">// 自分のSTAを調べる</span>
<a name="l00493"></a>00493         <span class="keywordflow">if</span> (getifaddrs(&amp;ifap0)) {
<a name="l00494"></a>00494             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[allocation_request_timeout] getifaddrs error %m"</span>);
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496         <span class="keywordflow">for</span> (ifap = ifap0; ifap; ifap = ifap-&gt;ifa_next) {
<a name="l00497"></a>00497             <span class="keywordflow">if</span> (strstr(ifap-&gt;ifa_name, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>)) {
<a name="l00498"></a>00498                 if (ifap-&gt;ifa_addr == NULL) {
<a name="l00499"></a>00499                     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[allocation_request_timeout] %s ifa_addr is NULL!!"</span>, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>);
<a name="l00500"></a>00500                     <span class="keywordflow">continue</span>;
<a name="l00501"></a>00501                 }
<a name="l00502"></a>00502                 <span class="keywordflow">if</span> (ifap-&gt;ifa_addr-&gt;sa_family == AF_INET6) {
<a name="l00503"></a>00503                     <span class="keyword">struct</span> sockaddr_in6 *temp_sockaddr_in6 = (<span class="keyword">struct</span> sockaddr_in6 *)(ifap-&gt;ifa_addr);
<a name="l00504"></a>00504                     if (<a class="code" href="stamanagement_8h.html#1fc4ca40df850703f916d515f1d8ba8b">IN6_IS_ADDR_STA</a>(&amp;temp_sockaddr_in6-&gt;sin6_addr)) {
<a name="l00505"></a>00505                         found = 1;
<a name="l00506"></a>00506                         mysta_sin6 = *temp_sockaddr_in6;
<a name="l00507"></a>00507                         <span class="keywordflow">break</span>;
<a name="l00508"></a>00508                     } <span class="keywordflow">else</span> {
<a name="l00509"></a>00509                         <span class="keywordflow">continue</span>;
<a name="l00510"></a>00510                     }
<a name="l00511"></a>00511                 } <span class="keywordflow">else</span> {
<a name="l00512"></a>00512                     <span class="comment">// v4アドレス</span>
<a name="l00513"></a>00513                     <span class="keywordflow">continue</span>;
<a name="l00514"></a>00514                 }
<a name="l00515"></a>00515             } <span class="keywordflow">else</span> {
<a name="l00516"></a>00516                 <span class="comment">// ath0以外</span>
<a name="l00517"></a>00517                 <span class="keywordflow">continue</span>;
<a name="l00518"></a>00518             }
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520         
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (found == 1) {
<a name="l00522"></a>00522             <a class="code" href="stamanagement_8c.html#de7e1ba2d15a89b76013f06794fc111b">delete_sta</a>(&amp;mysta_sin6);
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524         <a class="code" href="stamanagement_8c.html#4594982b4b7c93034dde116a25ef701b">add_sta</a>(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a>));
<a name="l00525"></a>00525         <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> = <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f421fd16671b5c3e4028ede353a9ace809df">NOT_DUPLICATE</a>;
<a name="l00526"></a>00526         <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#49a9f14a6ce5e86faff0d96db622a850">generated_time</a> = 0;
<a name="l00527"></a>00527         memset(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a>), 0, <span class="keyword">sizeof</span>(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a>));
<a name="l00528"></a>00528     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> == <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f4216d0b42a4ceb4a0594120df04371fad5f">DUPLICATE</a>) {
<a name="l00529"></a>00529         <span class="comment">// do nothing</span>
<a name="l00530"></a>00530         <span class="keywordtype">char</span> host[NI_MAXHOST];
<a name="l00531"></a>00531         getnameinfo((<span class="keyword">struct</span> sockaddr *)&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a>), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in6), host, <span class="keyword">sizeof</span>(host), NULL, 0, NI_NUMERICHOST);
<a name="l00532"></a>00532         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"# DUPLICATE [allcation_request_timeout] %s"</span>, host);
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534     pthread_mutex_unlock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00546"></a><a class="code" href="stamanagement_8c.html#b0d5fc7ffa90be68cc7cc71dd629d90e">00546</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#b0d5fc7ffa90be68cc7cc71dd629d90e">is_inside_valid_range</a>(<span class="keyword">const</span> <a class="code" href="struct__PositionOut.html">PositionOut</a> * <span class="keyword">const</span> real, <span class="keyword">const</span> <a class="code" href="struct__PositionOut.html">PositionOut</a> * <span class="keyword">const</span> decoded) {
<a name="l00547"></a>00547     <span class="keyword">const</span> <span class="keywordtype">double</span> cr = 50.0; 
<a name="l00548"></a>00548     <span class="keyword">const</span> <span class="keywordtype">double</span> lg = 1.0; 
<a name="l00549"></a>00549     <span class="keywordtype">int</span> cond1 = 0;
<a name="l00550"></a>00550     <span class="keywordtype">int</span> cond2 = 0;
<a name="l00551"></a>00551     <span class="keywordtype">int</span> cond3 = 0;
<a name="l00552"></a>00552     <span class="keywordtype">int</span> cond4 = 0;
<a name="l00553"></a>00553     
<a name="l00554"></a>00554     cond1 = (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) * <a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) * <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &lt;= (cr * cr));
<a name="l00555"></a>00555     cond1 &amp;= (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &gt;= <a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00556"></a>00556     cond1 &amp;= (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &gt;= <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00557"></a>00557     <span class="keywordflow">if</span> (!cond1) <span class="keywordflow">return</span> 0;
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     cond2 = (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) * <a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) * (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) &lt;= (cr * cr));
<a name="l00560"></a>00560     cond2 &amp;= (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &gt;= <a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00561"></a>00561     cond2 &amp;= (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &lt;= <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00562"></a>00562     <span class="keywordflow">if</span> (!cond2) <span class="keywordflow">return</span> 0;
<a name="l00563"></a>00563 
<a name="l00564"></a>00564     cond3 = ((<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) * (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) + <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) * <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &lt;= (cr * cr));
<a name="l00565"></a>00565     cond3 &amp;= (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &lt;= <a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00566"></a>00566     cond3 &amp;= (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &gt;= <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00567"></a>00567     <span class="keywordflow">if</span> (!cond3) <span class="keywordflow">return</span> 0;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     cond4 = ((<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) * (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) + (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) * (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a> - decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) - lg) &lt;= (cr * cr));
<a name="l00570"></a>00570     cond4 &amp;= (<a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(real-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &lt;= <a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#cd5670703bf5e42a8195083f008edada">lon</a>, decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00571"></a>00571     cond4 &amp;= (<a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(real-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) &lt;= <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(decoded-&gt;<a class="code" href="struct__PositionOut.html#0057ae2a69977acf6d292305299b5657">lat</a>) + lg / 2);
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (!cond4) <span class="keywordflow">return</span> 0;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (cond1 &amp;&amp; cond2 &amp;&amp; cond3 &amp;&amp; cond4) {
<a name="l00575"></a>00575         <span class="keywordflow">return</span> 1;
<a name="l00576"></a>00576     } <span class="keywordflow">else</span> {
<a name="l00577"></a>00577         <span class="keywordflow">return</span> 0;
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 
<a name="l00592"></a><a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">00592</a> <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="stamanagement_8c.html#ba0b62497c20a7255bbaf093703ba13b">lat2y</a>(<span class="keywordtype">double</span> lat) {
<a name="l00593"></a>00593     <span class="keywordflow">return</span> lat * 110952.0;
<a name="l00594"></a>00594 }
<a name="l00595"></a>00595 
<a name="l00605"></a><a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">00605</a> <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="stamanagement_8c.html#3b4cf741910b0a78cf0e191ec8532fcd">lon2x</a>(<span class="keywordtype">double</span> lon, <span class="keywordtype">double</span> lat) {
<a name="l00606"></a>00606     <span class="keywordflow">return</span> 111319.0 * lon * cos(lat);
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 
<a name="l00617"></a><a class="code" href="stamanagement_8c.html#ef019ef18a588d7ec1c27c3ca3a11892">00617</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#ef019ef18a588d7ec1c27c3ca3a11892">get_socket_for_afinet6</a>() {
<a name="l00618"></a>00618     <span class="keywordtype">int</span> fd = -1;
<a name="l00619"></a>00619     
<a name="l00620"></a>00620     fd = socket(AF_INET6, SOCK_DGRAM, 0);
<a name="l00621"></a>00621     <span class="keywordflow">return</span> fd;
<a name="l00622"></a>00622 }
<a name="l00623"></a>00623 
<a name="l00631"></a><a class="code" href="stamanagement_8c.html#e34c0c5c945089f9ac2e713b3c1ea11c">00631</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#e34c0c5c945089f9ac2e713b3c1ea11c">init_udp_socket</a>(pthread_t recv_from_udp_thread_id) {
<a name="l00632"></a>00632     <span class="keywordtype">int</span> status;
<a name="l00633"></a>00633     <span class="keywordtype">int</span> one = 1;
<a name="l00634"></a>00634     pthread_attr_t detached_attr;
<a name="l00635"></a>00635     <span class="keyword">struct </span>sockaddr_in6 my_sockaddr_in6;
<a name="l00636"></a>00636     
<a name="l00637"></a>00637     memset(&amp;my_sockaddr_in6, <span class="keyword">sizeof</span>(my_sockaddr_in6), 0);
<a name="l00638"></a>00638     my_sockaddr_in6.sin6_family = AF_INET6;
<a name="l00639"></a>00639     my_sockaddr_in6.sin6_addr = in6addr_any;
<a name="l00640"></a>00640     my_sockaddr_in6.sin6_port = htons(<a class="code" href="stamanagement_8h.html#8080d4d36d5d3d072be611a95f864ac1">udp_port</a>); <span class="comment">// これはおかしいかも。クライアント側のポートを自動で適当に設定するにはどうすればいいんだっけ…</span>
<a name="l00641"></a>00641     <a class="code" href="stamanagement_8h.html#d2c8fb3df3a737e0685e902870a611d2">sockfd</a> = socket(AF_INET6, SOCK_DGRAM, 0);
<a name="l00642"></a>00642     
<a name="l00643"></a>00643     <span class="keywordflow">if</span> (setsockopt(<a class="code" href="stamanagement_8h.html#d2c8fb3df3a737e0685e902870a611d2">sockfd</a>, SOL_SOCKET, SO_REUSEADDR, (<span class="keywordtype">char</span> *)&amp;one, <span class="keyword">sizeof</span>(one)) != 0) {
<a name="l00644"></a>00644         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[init_udp_socket] setsockopt error: %m"</span>);
<a name="l00645"></a>00645         <span class="keywordflow">return</span> -1;
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647     
<a name="l00648"></a>00648     <span class="keywordflow">if</span> (bind(<a class="code" href="stamanagement_8h.html#d2c8fb3df3a737e0685e902870a611d2">sockfd</a>, (<span class="keyword">struct</span> sockaddr *)&amp;my_sockaddr_in6, <span class="keyword">sizeof</span>(my_sockaddr_in6)) == -1) {
<a name="l00649"></a>00649         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[init_udp_socket] bind error: %m"</span>);
<a name="l00650"></a>00650         <span class="keywordflow">return</span> -1;
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652     
<a name="l00653"></a>00653     pthread_attr_init(&amp;detached_attr);
<a name="l00654"></a>00654     pthread_attr_setdetachstate(&amp;detached_attr, PTHREAD_CREATE_DETACHED);
<a name="l00655"></a>00655     
<a name="l00656"></a>00656     status = pthread_create(&amp;recv_from_udp_thread_id, &amp;detached_attr, <a class="code" href="stamanagement_8c.html#b436a10cb3c132bafcbe3d218958c0ba">recv_from_udp</a>, NULL);
<a name="l00657"></a>00657     <span class="comment">// status = pthread_create(&amp;recv_from_udp_thread_id, NULL, recv_from_udp, NULL);</span>
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (status != 0) {
<a name="l00659"></a>00659         syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[init_udp_socket] pthread_create error: %m"</span>);
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661     
<a name="l00662"></a>00662     <span class="keywordflow">return</span> status;
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00671"></a><a class="code" href="stamanagement_8h.html#e58d564f617415404afea0d1dc64a96d">00671</a> <span class="keywordtype">void</span> <a class="code" href="stamanagement_8c.html#efd93035a2129ca4d0bb7dd666afa5dc">init_temporary_address_status</a>() {
<a name="l00672"></a>00672     memset(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a>), 0, <span class="keyword">sizeof</span>(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a>));
<a name="l00673"></a>00673     <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#49a9f14a6ce5e86faff0d96db622a850">generated_time</a> = 0;
<a name="l00674"></a>00674     pthread_mutex_init(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>), NULL);
<a name="l00675"></a>00675     <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> = <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f421fd16671b5c3e4028ede353a9ace809df">NOT_DUPLICATE</a>;
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00685"></a><a class="code" href="stamanagement_8h.html#b436a10cb3c132bafcbe3d218958c0ba">00685</a> <span class="keywordtype">void</span> *<a class="code" href="stamanagement_8c.html#b436a10cb3c132bafcbe3d218958c0ba">recv_from_udp</a>(<span class="keywordtype">void</span> *arg) {
<a name="l00686"></a>00686     <a class="code" href="stamanagement_8h.html#86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(arg);
<a name="l00687"></a>00687     
<a name="l00688"></a>00688     <span class="keywordtype">int</span> status;
<a name="l00689"></a>00689     <span class="keywordtype">int</span> len;
<a name="l00690"></a>00690     <span class="keywordtype">char</span> *buf;
<a name="l00691"></a>00691     
<a name="l00692"></a>00692     <span class="keywordflow">while</span> (!<a class="code" href="stamanagement_8h.html#3a342de928b87eb91a4dc575124c38ad">srv_shutdown</a>) {
<a name="l00693"></a>00693         pthread_t recv_from_udp_child_thread_id;
<a name="l00694"></a>00694         pthread_attr_t detached_attr;
<a name="l00695"></a>00695         <span class="keyword">struct </span>sockaddr_storage from;
<a name="l00696"></a>00696         socklen_t fromlen;
<a name="l00697"></a>00697         <a class="code" href="struct__pthreadarg__addr__buf.html">pthreadarg_addr_buf</a> *pthreadarg;
<a name="l00698"></a>00698         
<a name="l00699"></a>00699         fromlen = <span class="keyword">sizeof</span>(from);
<a name="l00700"></a>00700         
<a name="l00701"></a>00701         buf = (<span class="keywordtype">char</span> *)malloc(<a class="code" href="stamanagement_8h.html#e28364758871ae4d32f458be867cb861">UDP_RECV_BUF_SIZE</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l00702"></a>00702         pthreadarg = (<a class="code" href="struct__pthreadarg__addr__buf.html">pthreadarg_addr_buf</a> *)malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct__pthreadarg__addr__buf.html">pthreadarg_addr_buf</a>));
<a name="l00703"></a>00703         
<a name="l00704"></a>00704         pthread_attr_init(&amp;detached_attr);
<a name="l00705"></a>00705         pthread_attr_setdetachstate(&amp;detached_attr, PTHREAD_CREATE_DETACHED);
<a name="l00706"></a>00706         
<a name="l00707"></a>00707         len = recvfrom(<a class="code" href="stamanagement_8h.html#d2c8fb3df3a737e0685e902870a611d2">sockfd</a>, buf, <a class="code" href="stamanagement_8h.html#e28364758871ae4d32f458be867cb861">UDP_RECV_BUF_SIZE</a>, 0, (<span class="keyword">struct</span> sockaddr *)&amp;from, &amp;fromlen);
<a name="l00708"></a>00708         <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l00709"></a>00709             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_udp] recvfrom error: %m"</span>);
<a name="l00710"></a>00710             <span class="keywordflow">continue</span>;
<a name="l00711"></a>00711         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len == 0) {
<a name="l00712"></a>00712             <span class="keywordtype">char</span> theotherside[NI_MAXHOST];
<a name="l00713"></a>00713             <span class="keywordtype">int</span> ret;
<a name="l00714"></a>00714             ret = getnameinfo((<span class="keyword">struct</span> sockaddr *)&amp;from, <span class="keyword">sizeof</span>(from), theotherside, <span class="keyword">sizeof</span>(theotherside), NULL, 0, NI_NUMERICHOST);
<a name="l00715"></a>00715             <span class="keywordflow">if</span> (ret != 0) {
<a name="l00716"></a>00716                 syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_udp] getnameinfo error: %s"</span>, gai_strerror(ret));
<a name="l00717"></a>00717             } <span class="keywordflow">else</span> {
<a name="l00718"></a>00718                 syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_udp] the other side(%s) shut down normally."</span>, theotherside);
<a name="l00719"></a>00719             }
<a name="l00720"></a>00720         } <span class="keywordflow">else</span> {
<a name="l00721"></a>00721             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_udp] %d"</span>, len);
<a name="l00722"></a>00722         }
<a name="l00723"></a>00723         
<a name="l00724"></a>00724         memcpy(&amp;(pthreadarg-&gt;<a class="code" href="struct__pthreadarg__addr__buf.html#bd04e2a3af92575afaa772caea944386">fromaddr</a>), &amp;from, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_storage));
<a name="l00725"></a>00725         pthreadarg-&gt;<a class="code" href="struct__pthreadarg__addr__buf.html#4a358427c7e649a921d9714d282803e3">buf</a> = buf;
<a name="l00726"></a>00726         pthreadarg-&gt;<a class="code" href="struct__pthreadarg__addr__buf.html#ca4f66da88af5fb46e4bf1054eb008c6">usedlen</a> = len;
<a name="l00727"></a>00727         
<a name="l00728"></a>00728         status = pthread_create(&amp;recv_from_udp_child_thread_id, &amp;detached_attr, <a class="code" href="stamanagement_8c.html#00b89cb54db657bc21c6afe770b65c66">recv_from_udp_child</a>, pthreadarg);
<a name="l00729"></a>00729         <span class="keywordflow">if</span> (status != 0) {
<a name="l00730"></a>00730             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_udp] pthread_create error: %m"</span>);
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733     <span class="keywordflow">return</span> NULL;
<a name="l00734"></a>00734 }
<a name="l00735"></a>00735 
<a name="l00742"></a><a class="code" href="stamanagement_8h.html#00b89cb54db657bc21c6afe770b65c66">00742</a> <span class="keywordtype">void</span> *<a class="code" href="stamanagement_8c.html#00b89cb54db657bc21c6afe770b65c66">recv_from_udp_child</a>(<span class="keywordtype">void</span> *arg) {
<a name="l00743"></a>00743     <a class="code" href="struct__pthreadarg__addr__buf.html">pthreadarg_addr_buf</a> *pthreadarg = (<a class="code" href="struct__pthreadarg__addr__buf.html">pthreadarg_addr_buf</a> *)arg;
<a name="l00744"></a>00744     <span class="keyword">struct </span>sockaddr_in6 *fromaddr = (<span class="keyword">struct </span>sockaddr_in6 *)&amp;(pthreadarg-&gt;<a class="code" href="struct__pthreadarg__addr__buf.html#bd04e2a3af92575afaa772caea944386">fromaddr</a>);
<a name="l00745"></a>00745     <span class="keywordtype">int</span> ret;
<a name="l00746"></a>00746     u_int16_t type;
<a name="l00747"></a>00747     <span class="keywordtype">char</span> *buf;
<a name="l00748"></a>00748     
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8c.html#882776ace026a93631fc479af2baba3f">packet_type_is_areq</a>(pthreadarg-&gt;<a class="code" href="struct__pthreadarg__addr__buf.html#4a358427c7e649a921d9714d282803e3">buf</a>)) { <span class="comment">// リゾルバの場合、AREQを受ける</span>
<a name="l00750"></a>00750         <span class="keyword">struct </span>sockaddr_in6 requested_address;
<a name="l00751"></a>00751         <a class="code" href="struct__arep__flag__reserved.html">arep_flag_reserved</a> flag_reserved;
<a name="l00752"></a>00752         <span class="keyword">struct </span>ifaddrs *ifap0, *ifap;
<a name="l00753"></a>00753         <span class="keyword">struct </span>sockaddr_in6 mysta_sin6;
<a name="l00754"></a>00754         
<a name="l00755"></a>00755         memcpy(&amp;requested_address, &amp;(pthreadarg-&gt;<a class="code" href="struct__pthreadarg__addr__buf.html#4a358427c7e649a921d9714d282803e3">buf</a>[<span class="keyword">sizeof</span>(type)]), <span class="keyword">sizeof</span>(requested_address));
<a name="l00756"></a>00756         memset(&amp;flag_reserved, 0, <span class="keyword">sizeof</span>(flag_reserved));
<a name="l00757"></a>00757         
<a name="l00758"></a>00758         type = <a class="code" href="stamanagement_8h.html#bc6e8f82175898b9c0bc5049571b474be863e27205922cf102ddede0f91a1311">AREP</a>;
<a name="l00759"></a>00759         buf = (<span class="keywordtype">char</span> *)malloc(<a class="code" href="stamanagement_8h.html#c1138f9b1cc919d42ca13b14ba4dd581">AREP_PACKET_SIZE</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l00760"></a>00760         memset(buf, 0, <a class="code" href="stamanagement_8h.html#c1138f9b1cc919d42ca13b14ba4dd581">AREP_PACKET_SIZE</a>);
<a name="l00761"></a>00761         memcpy(buf, &amp;type, <span class="keyword">sizeof</span>(type));
<a name="l00762"></a>00762         memcpy(&amp;(buf[<span class="keyword">sizeof</span>(type) + <span class="keyword">sizeof</span>(flag_reserved)]), &amp;requested_address, <span class="keyword">sizeof</span>(requested_address));
<a name="l00763"></a>00763         
<a name="l00764"></a>00764         <span class="comment">// 自分のSTAを調べる</span>
<a name="l00765"></a>00765         <span class="keywordflow">if</span> (getifaddrs(&amp;ifap0)) {
<a name="l00766"></a>00766             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_udp_child] getifaddrs error %m"</span>);
<a name="l00767"></a>00767         }
<a name="l00768"></a>00768         <span class="keywordflow">for</span> (ifap = ifap0; ifap; ifap = ifap-&gt;ifa_next) {
<a name="l00769"></a>00769             <span class="keywordflow">if</span> (strstr(ifap-&gt;ifa_name, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>)) {
<a name="l00770"></a>00770                 if (ifap-&gt;ifa_addr == NULL) {
<a name="l00771"></a>00771                     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"[recv_from_udp_child] %s ifa_addr is NULL!!"</span>, <a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>);
<a name="l00772"></a>00772                     <span class="keywordflow">continue</span>;
<a name="l00773"></a>00773                 }
<a name="l00774"></a>00774                 <span class="keywordflow">if</span> (ifap-&gt;ifa_addr-&gt;sa_family == AF_INET6) {
<a name="l00775"></a>00775                     <span class="keyword">struct</span> sockaddr_in6 *temp_sockaddr_in6 = (<span class="keyword">struct</span> sockaddr_in6 *)(ifap-&gt;ifa_addr);
<a name="l00776"></a>00776                     if (<a class="code" href="stamanagement_8h.html#1fc4ca40df850703f916d515f1d8ba8b">IN6_IS_ADDR_STA</a>(&amp;temp_sockaddr_in6-&gt;sin6_addr)) {
<a name="l00777"></a>00777                         mysta_sin6 = *temp_sockaddr_in6;
<a name="l00778"></a>00778                         <span class="keywordflow">break</span>;
<a name="l00779"></a>00779                     } <span class="keywordflow">else</span> {
<a name="l00780"></a>00780                         <span class="keywordflow">continue</span>;
<a name="l00781"></a>00781                     }
<a name="l00782"></a>00782                 } <span class="keywordflow">else</span> {
<a name="l00783"></a>00783                     <span class="comment">// v4アドレス</span>
<a name="l00784"></a>00784                     <span class="keywordflow">continue</span>;
<a name="l00785"></a>00785                 }
<a name="l00786"></a>00786             } <span class="keywordflow">else</span> {
<a name="l00787"></a>00787                 <span class="comment">// ath0以外</span>
<a name="l00788"></a>00788                 <span class="keywordflow">continue</span>;
<a name="l00789"></a>00789             }
<a name="l00790"></a>00790         }
<a name="l00791"></a>00791         
<a name="l00792"></a>00792         <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8c.html#1cc481b5987378c013d3437c5ffafa37">in6_addr_equal</a>(&amp;(requested_address.sin6_addr), &amp;(mysta_sin6.sin6_addr)) == 0) { <span class="comment">// 自分のアドレスと異なる</span>
<a name="l00793"></a>00793             <span class="comment">// AREP_FLAG=0のパケットを返す</span>
<a name="l00794"></a>00794             flag_reserved.arep_flag = 0;
<a name="l00795"></a>00795             memcpy(&amp;(buf[<span class="keyword">sizeof</span>(type)]), &amp;flag_reserved, <span class="keyword">sizeof</span>(flag_reserved));
<a name="l00796"></a>00796             ret = sendto(<a class="code" href="stamanagement_8h.html#d2c8fb3df3a737e0685e902870a611d2">sockfd</a>, buf, <a class="code" href="stamanagement_8h.html#c1138f9b1cc919d42ca13b14ba4dd581">AREP_PACKET_SIZE</a>, 0, (<span class="keyword">struct</span> sockaddr *)fromaddr, <span class="keyword">sizeof</span>(fromaddr));
<a name="l00797"></a>00797         } <span class="keywordflow">else</span> { <span class="comment">// 同じ、重複</span>
<a name="l00798"></a>00798             <span class="comment">// AREP_FLAG=1のパケットを返す</span>
<a name="l00799"></a>00799             flag_reserved.arep_flag = 1;
<a name="l00800"></a>00800             memcpy(&amp;(buf[<span class="keyword">sizeof</span>(type)]), &amp;flag_reserved, <span class="keyword">sizeof</span>(flag_reserved));
<a name="l00801"></a>00801             ret = sendto(<a class="code" href="stamanagement_8h.html#d2c8fb3df3a737e0685e902870a611d2">sockfd</a>, buf, <a class="code" href="stamanagement_8h.html#c1138f9b1cc919d42ca13b14ba4dd581">AREP_PACKET_SIZE</a>, 0, (<span class="keyword">struct</span> sockaddr *)fromaddr, <span class="keyword">sizeof</span>(fromaddr));
<a name="l00802"></a>00802         }
<a name="l00803"></a>00803         
<a name="l00804"></a>00804         free(buf);
<a name="l00805"></a>00805         <span class="keywordflow">return</span> NULL;
<a name="l00806"></a>00806         
<a name="l00807"></a>00807     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8c.html#d5afe3d4e60726265351ff358448cc81">packet_type_is_arep</a>(pthreadarg-&gt;buf)) { <span class="comment">// スタータの場合、AREP(DADの返答)を受け取る</span>
<a name="l00808"></a>00808         <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8c.html#71926b77bb44d1116dd86f6ffde9d94a">is_duplicate</a>(pthreadarg-&gt;buf) == 0) {
<a name="l00809"></a>00809             <span class="keywordflow">return</span> NULL; <span class="comment">// do nothing</span>
<a name="l00810"></a>00810         } <span class="keywordflow">else</span> { <span class="comment">// 重複あり</span>
<a name="l00811"></a>00811             <span class="comment">// タイマーをすぐ止めてイベント発生させる</span>
<a name="l00812"></a>00812             <span class="keywordtype">char</span> host[NI_MAXHOST];
<a name="l00813"></a>00813             pthread_mutex_lock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00814"></a>00814             <a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#5264f13a84f09455a2139d2cb8b8c3e2">flag</a> = <a class="code" href="stamanagement_8h.html#1ed672415919c5a0646a9909e016f4216d0b42a4ceb4a0594120df04371fad5f">DUPLICATE</a>;
<a name="l00815"></a>00815             getnameinfo((<span class="keyword">struct</span> sockaddr *)&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#7ba4c1553b119b8ccefdf4dcc2cdd2e3">address</a>), <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in6), host, <span class="keyword">sizeof</span>(host), NULL, 0, NI_NUMERICHOST);
<a name="l00816"></a>00816             pthread_mutex_unlock(&amp;(<a class="code" href="stamanagement_8h.html#37ce4b0b1ed4cf613fd5da9a23aad729">temp_address</a>.<a class="code" href="struct__temporary__address__status.html#aa17813c6a76779aeddef53f8aaba579">mutex</a>));
<a name="l00817"></a>00817             syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"# DUPLICATE [recv_from_udp_child] %s"</span>, host);
<a name="l00818"></a>00818             <a class="code" href="sta__timer_8c.html#4dbd8be10e8d8a85dbdc1d290fdb607b">timer_off</a>(0);
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821     <span class="keywordflow">return</span> NULL;
<a name="l00822"></a>00822 }
<a name="l00823"></a>00823 
<a name="l00832"></a><a class="code" href="stamanagement_8c.html#882776ace026a93631fc479af2baba3f">00832</a> <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#882776ace026a93631fc479af2baba3f">packet_type_is_areq</a>(<span class="keywordtype">char</span> *buf) {
<a name="l00833"></a>00833     u_int16_t type;
<a name="l00834"></a>00834     memcpy(&amp;type, buf, <span class="keyword">sizeof</span>(type));
<a name="l00835"></a>00835     
<a name="l00836"></a>00836     <span class="keywordflow">if</span> (type == <a class="code" href="stamanagement_8h.html#bc6e8f82175898b9c0bc5049571b474b9ab10d084d2aa43c5a5fee1ae99a8968">AREQ</a>) {
<a name="l00837"></a>00837         <span class="keywordflow">return</span> 1;
<a name="l00838"></a>00838     } <span class="keywordflow">else</span> { <span class="comment">// それ以外</span>
<a name="l00839"></a>00839         <span class="keywordflow">return</span> 0;
<a name="l00840"></a>00840     }
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00851"></a><a class="code" href="stamanagement_8c.html#d5afe3d4e60726265351ff358448cc81">00851</a> <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#d5afe3d4e60726265351ff358448cc81">packet_type_is_arep</a>(<span class="keywordtype">char</span> *buf) {
<a name="l00852"></a>00852     u_int16_t type;
<a name="l00853"></a>00853     memcpy(&amp;type, buf, <span class="keyword">sizeof</span>(type));
<a name="l00854"></a>00854     
<a name="l00855"></a>00855     <span class="keywordflow">if</span> (type == <a class="code" href="stamanagement_8h.html#bc6e8f82175898b9c0bc5049571b474be863e27205922cf102ddede0f91a1311">AREP</a>) {
<a name="l00856"></a>00856         <span class="keywordflow">return</span> 1;
<a name="l00857"></a>00857     } <span class="keywordflow">else</span> { <span class="comment">// それ以外</span>
<a name="l00858"></a>00858         <span class="keywordflow">return</span> 0;
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00871"></a><a class="code" href="stamanagement_8c.html#71926b77bb44d1116dd86f6ffde9d94a">00871</a> <span class="keyword">inline</span> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#71926b77bb44d1116dd86f6ffde9d94a">is_duplicate</a>(<span class="keywordtype">char</span> *buf) {
<a name="l00872"></a>00872     <span class="keywordflow">if</span> (buf[16] == 0) { <span class="comment">// 重複なし</span>
<a name="l00873"></a>00873         <span class="keywordflow">return</span> 0;
<a name="l00874"></a>00874     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (buf[16] == 1) { <span class="comment">// 重複あり</span>
<a name="l00875"></a>00875         <span class="keywordflow">return</span> 1;
<a name="l00876"></a>00876     } <span class="keywordflow">else</span> {
<a name="l00877"></a>00877         assert(0);
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879 }
<a name="l00880"></a>00880 
<a name="l00889"></a><a class="code" href="stamanagement_8c.html#2a20974208b6a1ef316e2b916f18e93f">00889</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stamanagement_8c.html#2a20974208b6a1ef316e2b916f18e93f">sigaction_handler</a>(<span class="keywordtype">int</span> sig, siginfo_t *si, <span class="keywordtype">void</span> *context) {
<a name="l00890"></a>00890     <a class="code" href="stamanagement_8h.html#86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(si);
<a name="l00891"></a>00891     <a class="code" href="stamanagement_8h.html#86d500a34c624c2cae56bc25a31b12f3">UNUSED</a>(context);
<a name="l00892"></a>00892     
<a name="l00893"></a>00893     <span class="keywordflow">switch</span> (sig) {
<a name="l00894"></a>00894     <span class="keywordflow">case</span> SIGINT:
<a name="l00895"></a>00895         <a class="code" href="stamanagement_8h.html#3a342de928b87eb91a4dc575124c38ad">srv_shutdown</a> = 1;
<a name="l00896"></a>00896         <span class="comment">//fprintf(stderr, "sigint\n");</span>
<a name="l00897"></a>00897         <span class="keywordflow">break</span>;
<a name="l00898"></a>00898     <span class="keywordflow">default</span>:
<a name="l00899"></a>00899         <span class="keywordflow">break</span>;
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901 }
<a name="l00902"></a>00902 
<a name="l00908"></a><a class="code" href="stamanagement_8c.html#81a84336b76bad022600aed0e45ad74c">00908</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stamanagement_8c.html#81a84336b76bad022600aed0e45ad74c">init_parameters</a>() {
<a name="l00909"></a>00909     memset(<a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>, 0, 5);
<a name="l00910"></a>00910     strncpy(<a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>, <a class="code" href="stamanagement_8h.html#6dc1ddf30ef2898033f14154d74b4c50">WLAN_INTERFACE</a>, <span class="keyword">sizeof</span>(<a class="code" href="stamanagement_8h.html#6dc1ddf30ef2898033f14154d74b4c50">WLAN_INTERFACE</a>));
<a name="l00911"></a>00911     
<a name="l00912"></a>00912     memset(<a class="code" href="stamanagement_8h.html#64d743b19034f4f56fe32383fd890b00">fifo_path</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="stamanagement_8h.html#64d743b19034f4f56fe32383fd890b00">fifo_path</a>));
<a name="l00913"></a>00913     strncpy(fifo_path, <a class="code" href="stamanagement_8h.html#ad4faa9cbd31e932b5cd29353d37367d">FIFOPATH</a>, <span class="keyword">sizeof</span>(<a class="code" href="stamanagement_8h.html#ad4faa9cbd31e932b5cd29353d37367d">FIFOPATH</a>));
<a name="l00914"></a>00914     
<a name="l00915"></a>00915     <a class="code" href="stamanagement_8h.html#852214fee107d32377ac550a65b57637">waiting_time</a> = <a class="code" href="stamanagement_8h.html#96d13532625730eddbdf008e03926fc8">WAITING_TIME</a>;
<a name="l00916"></a>00916     <a class="code" href="stamanagement_8h.html#8080d4d36d5d3d072be611a95f864ac1">udp_port</a> = <a class="code" href="stamanagement_8h.html#a6186b8924bae52ceeb5c517c28d777f">UDP_PORT_NUMBER</a>;
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00924"></a><a class="code" href="stamanagement_8c.html#64a6014565bb3e03294ec4a952d5add0">00924</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stamanagement_8c.html#64a6014565bb3e03294ec4a952d5add0">usage</a>() {
<a name="l00925"></a>00925     fprintf(stderr, <span class="stringliteral">"Usage: stamd [options]\n"</span>);
<a name="l00926"></a>00926     fprintf(stderr, <span class="stringliteral">"where options are:\n"</span>);
<a name="l00927"></a>00927     fprintf(stderr, <span class="stringliteral">"  -f fifo_path : Path to FIFO. (%s)\n"</span>, <a class="code" href="stamanagement_8h.html#ad4faa9cbd31e932b5cd29353d37367d">FIFOPATH</a>);
<a name="l00928"></a>00928     fprintf(stderr, <span class="stringliteral">"  -h : Show this message and exit.\n"</span>);
<a name="l00929"></a>00929     fprintf(stderr, <span class="stringliteral">"  -i wlan_interface : WLAN Interface to use. (%s)\n"</span>, <a class="code" href="stamanagement_8h.html#6dc1ddf30ef2898033f14154d74b4c50">WLAN_INTERFACE</a>);
<a name="l00930"></a>00930     fprintf(stderr, <span class="stringliteral">"  -n : Not daemonize.\n"</span>);
<a name="l00931"></a>00931     fprintf(stderr, <span class="stringliteral">"  -p port : UDP port number. (%d)\n"</span>, <a class="code" href="stamanagement_8h.html#a6186b8924bae52ceeb5c517c28d777f">UDP_PORT_NUMBER</a>);
<a name="l00932"></a>00932     fprintf(stderr, <span class="stringliteral">"  -t waiting_time : Waiting Time [sec] in DAD. (%d)\n"</span>, <a class="code" href="stamanagement_8h.html#96d13532625730eddbdf008e03926fc8">WAITING_TIME</a>);
<a name="l00933"></a>00933     exit(1);
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00944"></a><a class="code" href="stamanagement_8c.html#3c04138a5bfe5d72780bb7e82a18e627">00944</a> <span class="keywordtype">int</span> <a class="code" href="stamanagement_8c.html#3c04138a5bfe5d72780bb7e82a18e627">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {
<a name="l00945"></a>00945     pthread_t recv_from_fifo_thread_id; <span class="comment">// LocationmwからのFIFO受信スレッド</span>
<a name="l00946"></a>00946     pthread_t recv_from_udp_thread_id;
<a name="l00947"></a>00947     <span class="keywordtype">int</span> ret;
<a name="l00948"></a>00948     <span class="keyword">struct </span>sigaction act;
<a name="l00949"></a>00949     
<a name="l00950"></a>00950     memset(&amp;act, 0, <span class="keyword">sizeof</span>(act));
<a name="l00951"></a>00951 
<a name="l00952"></a>00952     openlog(<span class="stringliteral">"stamd"</span>, LOG_PID, LOG_LOCAL0|LOG_DEBUG);
<a name="l00953"></a>00953     printf(<span class="stringliteral">"STA Management Daemon started...\n"</span>);
<a name="l00954"></a>00954     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"STA Management Daemon started..."</span>);
<a name="l00955"></a>00955     
<a name="l00956"></a>00956     <a class="code" href="stamanagement_8c.html#81a84336b76bad022600aed0e45ad74c">init_parameters</a>();
<a name="l00957"></a>00957     
<a name="l00958"></a>00958     <span class="keywordflow">while</span> ((ret = getopt(argc, argv, <span class="stringliteral">"fhi:np:t:"</span>)) != -1) {
<a name="l00959"></a>00959         <span class="keywordflow">switch</span> (ret) {
<a name="l00960"></a>00960         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
<a name="l00961"></a>00961             strncpy(<a class="code" href="stamanagement_8h.html#64d743b19034f4f56fe32383fd890b00">fifo_path</a>, optarg, <span class="keyword">sizeof</span>(fifo_path) - 1);
<a name="l00962"></a>00962             <span class="keywordflow">break</span>;
<a name="l00963"></a>00963         <span class="keywordflow">case</span> <span class="charliteral">'h'</span>:
<a name="l00964"></a>00964             <a class="code" href="stamanagement_8c.html#64a6014565bb3e03294ec4a952d5add0">usage</a>();
<a name="l00965"></a>00965             <span class="keywordflow">break</span>;
<a name="l00966"></a>00966         <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
<a name="l00967"></a>00967             strncpy(<a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>, optarg, <span class="keyword">sizeof</span>(<a class="code" href="stamanagement_8h.html#5eb693f34f101730533b75627415bcf6">wlan_interface</a>) - 1);
<a name="l00968"></a>00968             <span class="keywordflow">break</span>;
<a name="l00969"></a>00969         <span class="keywordflow">case</span> <span class="charliteral">'n'</span>:
<a name="l00970"></a>00970             <a class="code" href="stamanagement_8h.html#a2339b21f98abccd12533a54d5f9d712">daemonize</a> = 0;
<a name="l00971"></a>00971             <span class="keywordflow">break</span>;
<a name="l00972"></a>00972         <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
<a name="l00973"></a>00973             <a class="code" href="stamanagement_8h.html#8080d4d36d5d3d072be611a95f864ac1">udp_port</a> = atoi(optarg);
<a name="l00974"></a>00974             <span class="keywordflow">break</span>;
<a name="l00975"></a>00975         <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
<a name="l00976"></a>00976             <a class="code" href="stamanagement_8h.html#852214fee107d32377ac550a65b57637">waiting_time</a> = atoi(optarg);
<a name="l00977"></a>00977             <span class="keywordflow">break</span>;
<a name="l00978"></a>00978         <span class="keywordflow">default</span>:
<a name="l00979"></a>00979             <a class="code" href="stamanagement_8c.html#64a6014565bb3e03294ec4a952d5add0">usage</a>();
<a name="l00980"></a>00980         }
<a name="l00981"></a>00981     }
<a name="l00982"></a>00982     
<a name="l00983"></a>00983     <span class="keywordflow">if</span> (<a class="code" href="stamanagement_8h.html#a2339b21f98abccd12533a54d5f9d712">daemonize</a>) {
<a name="l00984"></a>00984         daemon(0, 1);
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986     
<a name="l00987"></a>00987     act.sa_sigaction = <a class="code" href="stamanagement_8c.html#2a20974208b6a1ef316e2b916f18e93f">sigaction_handler</a>;
<a name="l00988"></a>00988     sigemptyset(&amp;act.sa_mask);
<a name="l00989"></a>00989     act.sa_flags = SA_SIGINFO;
<a name="l00990"></a>00990     <span class="keywordflow">if</span> ((sigaction(SIGINT, &amp;act, NULL)) != 0) {
<a name="l00991"></a>00991         fprintf(stderr, <span class="stringliteral">"sigaction err: %m"</span>);
<a name="l00992"></a>00992         printf(<span class="stringliteral">"STA Management Daemon dying...\n"</span>);
<a name="l00993"></a>00993         closelog();
<a name="l00994"></a>00994         <span class="keywordflow">return</span> -1;
<a name="l00995"></a>00995     }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997     <a class="code" href="stamanagement_8c.html#efd93035a2129ca4d0bb7dd666afa5dc">init_temporary_address_status</a>();
<a name="l00998"></a>00998     <a class="code" href="stamanagement_8c.html#e34c0c5c945089f9ac2e713b3c1ea11c">init_udp_socket</a>(recv_from_udp_thread_id);
<a name="l00999"></a>00999     
<a name="l01000"></a>01000     ret = pthread_create(&amp;recv_from_fifo_thread_id, NULL, <a class="code" href="stamanagement_8c.html#00324e0b02ef9c19bcc630c1e8b687ee">recv_from_fifo</a>, (<span class="keywordtype">void</span> *)NULL);
<a name="l01001"></a>01001     
<a name="l01002"></a>01002     pthread_join(recv_from_fifo_thread_id, NULL);
<a name="l01003"></a>01003     syslog(LOG_LOCAL0|LOG_DEBUG, <span class="stringliteral">"STA Management Daemon dying..."</span>);
<a name="l01004"></a>01004     printf(<span class="stringliteral">"STA Management Daemon dying...\n"</span>);
<a name="l01005"></a>01005     
<a name="l01006"></a>01006     closelog();
<a name="l01007"></a>01007     <span class="keywordflow">return</span> 0;
<a name="l01008"></a>01008 }
<a name="l01009"></a>01009 
</pre></div><hr size="1"><address style="align: right;"><small>STA Management Daemonに対してSat Jan 27 18:50:19 2007に生成されました。&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1 </small></address>
</body>
</html>
